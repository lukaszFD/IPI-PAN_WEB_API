/*
Deployment script for GlobalRepository

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "GlobalRepository"
:setvar DefaultFilePrefix "GlobalRepository"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL14.SQLEXPRESS\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL14.SQLEXPRESS\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping unnamed constraint on [gr_user].[Users]...';


GO
ALTER TABLE [gr_user].[Users] DROP CONSTRAINT [DF__Users__CreationD__7F80E8EA];


GO
PRINT N'Dropping unnamed constraint on [repository].[Accounts]...';


GO
ALTER TABLE [repository].[Accounts] DROP CONSTRAINT [FK__Accounts__UserId__24E777C3];


GO
PRINT N'Starting rebuilding table [gr_user].[Users]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [gr_user].[tmp_ms_xx_Users] (
    [ExternalId]   UNIQUEIDENTIFIER NOT NULL,
    [UserId]       INT              IDENTITY (1, 1) NOT NULL,
    [Description]  NVARCHAR (200)   NULL,
    [Username]     NVARCHAR (200)   NULL,
    [Password]     NVARCHAR (200)   NULL,
    [Type]         CHAR (1)         NOT NULL,
    [CreationDate] DATETIME         DEFAULT (getdate()) NOT NULL,
    [EditDate]     DATETIME         NULL,
    [DeleteDate]   DATETIME         NULL,
    PRIMARY KEY CLUSTERED ([UserId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [gr_user].[Users])
    BEGIN
        SET IDENTITY_INSERT [gr_user].[tmp_ms_xx_Users] ON;
        INSERT INTO [gr_user].[tmp_ms_xx_Users] ([UserId], [ExternalId], [Description], [Type], [CreationDate], [EditDate], [DeleteDate])
        SELECT   [UserId],
                 [ExternalId],
                 [Description],
                 [Type],
                 [CreationDate],
                 [EditDate],
                 [DeleteDate]
        FROM     [gr_user].[Users]
        ORDER BY [UserId] ASC;
        SET IDENTITY_INSERT [gr_user].[tmp_ms_xx_Users] OFF;
    END

DROP TABLE [gr_user].[Users];

EXECUTE sp_rename N'[gr_user].[tmp_ms_xx_Users]', N'Users';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating unnamed constraint on [repository].[Accounts]...';


GO
ALTER TABLE [repository].[Accounts] WITH NOCHECK
    ADD FOREIGN KEY ([UserId]) REFERENCES [gr_user].[Users] ([UserId]);


GO
PRINT N'Creating unnamed constraint on [gr_user].[Users]...';


GO
ALTER TABLE [gr_user].[Users] WITH NOCHECK
    ADD CHECK ([Type]='A' OR [Type]='N');


GO
PRINT N'Creating [gr_user].[After_U_Users_trg]...';


GO
CREATE TRIGGER gr_user.After_U_Users_trg
ON gr_user.[Users]
AFTER UPDATE
AS 
BEGIN
SET NOCOUNT ON;

	UPDATE a
	SET a.EditDate = getdate()
	FROM 
		gr_user.[Users] a 
		JOIN inserted i ON i.[UserId] = a.[UserId]
END
GO
PRINT N'Creating [gr_user].[Users].[ExternalId].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Id retrieved from the database that performs the authorization.', @level0type = N'SCHEMA', @level0name = N'gr_user', @level1type = N'TABLE', @level1name = N'Users', @level2type = N'COLUMN', @level2name = N'ExternalId';


GO
PRINT N'Creating [gr_user].[Users].[UserId].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'User ID on the database. In relation to [GlobalRepository]. [repository].[Accounts].[UserId]', @level0type = N'SCHEMA', @level0name = N'gr_user', @level1type = N'TABLE', @level1name = N'Users', @level2type = N'COLUMN', @level2name = N'UserId';


GO
PRINT N'Creating [gr_user].[Users].[Description].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Short description of the user.', @level0type = N'SCHEMA', @level0name = N'gr_user', @level1type = N'TABLE', @level1name = N'Users', @level2type = N'COLUMN', @level2name = N'Description';


GO
PRINT N'Creating [gr_user].[Users].[Type].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'User type: A - administrator, N - normal ', @level0type = N'SCHEMA', @level0name = N'gr_user', @level1type = N'TABLE', @level1name = N'Users', @level2type = N'COLUMN', @level2name = N'Type';


GO
PRINT N'Creating [gr_user].[Users].[CreationDate].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The date of creation of the user. ', @level0type = N'SCHEMA', @level0name = N'gr_user', @level1type = N'TABLE', @level1name = N'Users', @level2type = N'COLUMN', @level2name = N'CreationDate';


GO
PRINT N'Creating [gr_user].[Users].[EditDate].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'The date of editing the user. ', @level0type = N'SCHEMA', @level0name = N'gr_user', @level1type = N'TABLE', @level1name = N'Users', @level2type = N'COLUMN', @level2name = N'EditDate';


GO
PRINT N'Creating [gr_user].[Users].[DeleteDate].[MS_Description]...';


GO
EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N'Date of removal of the user. ', @level0type = N'SCHEMA', @level0name = N'gr_user', @level1type = N'TABLE', @level1name = N'Users', @level2type = N'COLUMN', @level2name = N'DeleteDate';


GO
PRINT N'Refreshing [recon].[MergeReconAccounts]...';


GO
EXECUTE sp_refreshsqlmodule N'[recon].[MergeReconAccounts]';


GO
-- Disable all the constraint in database
EXEC sp_msforeachtable "ALTER TABLE ? NOCHECK CONSTRAINT all"
GO

-- Reset identity 
PRINT 'Start Reset identity'
GO

DBCC CHECKIDENT ('repository.CountryRegion', RESEED, 0)
GO

DBCC CHECKIDENT ('error.ErrorMessages', RESEED, 0)
GO

DBCC CHECKIDENT ('repository.Accounts', RESEED, 0)
GO

DBCC CHECKIDENT ('repository.Servers', RESEED, 0)
GO

DBCC CHECKIDENT ('repository.Systems', RESEED, 0)
GO

DBCC CHECKIDENT ('recon.Accounts', RESEED, 0)
GO

DBCC CHECKIDENT ('recon.Servers', RESEED, 0)
GO

DBCC CHECKIDENT ('recon.Systems', RESEED, 0)
GO

DBCC CHECKIDENT ('audit.Accounts', RESEED, 0)
GO

DBCC CHECKIDENT ('audit.Servers', RESEED, 0)
GO

DBCC CHECKIDENT ('audit.Systems', RESEED, 0)
GO

PRINT 'Stop Reset identity'
GO

-- Delete data 
PRINT 'Start Delete data'
GO

DELETE FROM repository.CountryRegion
GO

DELETE FROM error.ErrorMessages
GO

DELETE FROM repository.Accounts
GO

DELETE FROM repository.Servers
GO

DELETE FROM repository.Systems
GO

DELETE FROM recon.Accounts
GO

DELETE FROM recon.Servers
GO

DELETE FROM recon.Systems
GO

DELETE FROM audit.Accounts
GO

DELETE FROM audit.Servers
GO

DELETE FROM audit.Systems
GO

PRINT 'Stop Delete data'
GO

---------------------------------------------------------
----------INSERT INTO repository.CountryRegion-----------
---------------------------------------------------------

BEGIN TRAN INSERT_INTO_CountryRegion
PRINT 'Start INSERT_INTO_repository_CountryRegion'

INSERT INTO [repository].[CountryRegion] ([CountryRegionCode],[Name])

SELECT 
	[CountryRegionCode]
   ,[Name]
FROM 
	[AdventureWorks2017].[Person].[CountryRegion]

PRINT 'Stop INSERT_INTO_repository_CountryRegion'
COMMIT TRAN INSERT_INTO_CountryRegion
GO

---------------------------------------------------------
----------INSERT INTO repository.Servers----------------
---------------------------------------------------------

BEGIN TRAN INSERT_INTO_repository_Servers
PRINT 'Start INSERT_INTO_repository_Servers'
DECLARE 

@number int = 1,
@Name nvarchar(50) = 'Server_{0}',
@Host nvarchar(50) = 'GR.{0}.{1}.net',
@Model nvarchar(50) = '{0}.{1}.{2}.{3}',
@SerialNumber int

WHILE @number <= 237
BEGIN
INSERT INTO repository.Servers
           (
		    Name
           ,Host
           ,CountryId
           ,Model
           ,SerialNumber
           ,WarrantyExpirationDate
           ,CPUType
           ,RAM
           ,HardDisk
           ,UPS
           ,AntivirusSoftware)
     VALUES
           (replace(@Name,'{0}', cast(@number AS nvarchar(50)))
           ,replace (replace(@Host,'{0}',RIGHT( LEFT('6027893415',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)),'{1}', RIGHT( LEFT('6893027415',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1))
           ,FLOOR(RAND()*(200-0+1))+10
           ,replace (replace (replace (replace(@Model,'{0}',RIGHT( LEFT('6893027415',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)),'{1}', RIGHT( LEFT('6893027415',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)),'{2}', RIGHT( LEFT('6893027415',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)),'{3}',RIGHT( LEFT('6893027415',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1))
           ,CAST(RAND() * 1000000 AS INT)
           ,DATEADD(DAY, ABS(CHECKSUM(NEWID()) % 1650), '2018-01-01')
           ,64
           ,256
           ,RIGHT( LEFT('DS',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)
           ,RIGHT( LEFT('01',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)
           ,RIGHT( LEFT('01',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)
		   )
    SET @number = @number + 1;
END
PRINT 'Stop INSERT_INTO_repository_Servers'
COMMIT TRAN INSERT_INTO_repository_Servers
GO

---------------------------------------------------------
----------INSERT INTO repository.Systems----------------
---------------------------------------------------------
BEGIN TRAN INSERT_INTO_repository_Systems
PRINT 'Start INSERT_INTO_repository_Systems'
DECLARE 

@number int = 1,
@Name nvarchar(50) = 'System_{0}',
@Version nvarchar(50) = '{0}.{1}.{2}.{3}'

WHILE @number <= 237
BEGIN
INSERT INTO repository.Systems
           (CompanyName
           ,Name
           ,Version
           ,TechSupportExpDate)
     VALUES
           (CASE WHEN RIGHT( LEFT('123',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1) = '1' then 'Microsoft' WHEN RIGHT( LEFT('123',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1) = '2' then 'Oracle' ELSE 'IBM' end
		   ,replace(@Name,'{0}', cast(@number AS nvarchar(50)))
           ,replace (replace (replace (replace(@Version,'{0}',RIGHT( LEFT('0123456789',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)),'{1}', RIGHT( LEFT('0123456789',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)),'{2}', RIGHT( LEFT('0123456789',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1)),'{3}',RIGHT( LEFT('0123456789',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1))
		   ,DATEADD(DAY, ABS(CHECKSUM(NEWID()) % 1650), '2018-01-01')
		   )
    SET @number = @number + 1;
END
PRINT 'Stop INSERT_INTO_repository_Systems'
COMMIT TRAN INSERT_INTO_repository_Systems
GO

---------------------------------------------------------
----------INSERT INTO repository.Accounts----------------
---------------------------------------------------------
BEGIN TRAN INSERT_INTO_repository_Accounts
PRINT 'Start INSERT_INTO_repository_Accounts'
DECLARE 
	@number int = 1,
	@Name nvarchar(50) = 'Konto',
	@PasswordExpires datetime = getdate()

WHILE @number <= 237
BEGIN
INSERT INTO repository.Accounts
           (CountryId 
           ,SystemId
           ,ServerId
           ,Name
           ,Type)
     VALUES
           (FLOOR(RAND()*(200-0+1))+10 
           ,@number
           ,@number
           ,@Name +'_'+ cast(@number AS nvarchar(100))
           ,RIGHT( LEFT('DU',ABS(BINARY_CHECKSUM(NEWID())%35) + 1 ),1))

    SET @number = @number + 1;
END
PRINT 'Stop INSERT_INTO_repository_Accounts'
COMMIT TRAN INSERT_INTO_repository_Accounts
GO


---------------------------------------------------------
--------------INSERT INTO recon.Servers------------------
---------------------------------------------------------
BEGIN TRAN INSERT_INTO_recon_Servers
PRINT 'Start INSERT_INTO_recon_Servers'
DECLARE 

@number int = 1

WHILE @number <= 100
BEGIN
	INSERT INTO  recon.Servers 
	(
		 ServerExId
		,Name
		,Host
		,CountryRegionCode
		,Model
		,SerialNumber
		,WarrantyExpirationDate
		,CPUType
        ,RAM
		,HardDisk
		,UPS
		,AntivirusSoftware
	)

	SELECT TOP (10) 
		 s.ExternalId
		,case 
			when s.Name like '%7%' then null
			else s.Name
			end as Name
		,s.Host
		,(select cr.CountryRegionCode from repository.CountryRegion cr WHERE cr.CountryId = FLOOR(RAND()*(s.ServerId-0+10))+10) AS CountryRegionCode
		,s.Model
		,s.SerialNumber
		,case 
			when s.WarrantyExpirationDate < getdate()
			THEN DATEADD(DAY,10,s.WarrantyExpirationDate)
			ELSE s.WarrantyExpirationDate
			END AS WarrantyExpirationDate
		,s.CPUType
        ,s.RAM
		,case 
			when s.Name like '%1%' then null
			else s.HardDisk
			end as HardDisk
		,s.UPS
		,s.AntivirusSoftware
	FROM 
		repository.Servers s
	ORDER BY NEWID()

    SET @number = @number + 1;
END
PRINT 'Stop INSERT_INTO_recon_Servers'
COMMIT TRAN INSERT_INTO_recon_Servers
GO

---------------------------------------------------------
----------------INSERT INTO recon.Systems----------------
---------------------------------------------------------
BEGIN TRAN INSERT_INTO_recon_Systems
PRINT 'Start INSERT_INTO_recon_Systems'
DECLARE 

@number int = 1

WHILE @number <= 100
BEGIN
INSERT INTO recon.Systems
           (
		    SystemExId
		   ,CompanyName
           ,Name
           ,Version
           ,TechSupportExpDate)
	 SELECT TOP (10) 
		 ExternalId
		,case 
			when Name like '%8%' then null
			else CompanyName
			end as CompanyName
		,Name
		,Version
		,case 
			when TechSupportExpDate < getdate()
			THEN DATEADD(DAY,10,TechSupportExpDate)
			ELSE TechSupportExpDate
			END AS TechSupportExpDate
	FROM 
		repository.Systems
	ORDER BY NEWID()

    SET @number = @number + 1;
END
PRINT 'Stop INSERT_INTO_recon_Systems'
COMMIT TRAN INSERT_INTO_recon_Systems
GO

---------------------------------------------------------
----------INSERT INTO recon.Accounts----------------
---------------------------------------------------------
BEGIN TRAN INSERT_INTO_recon_Accounts
PRINT 'Start INSERT_INTO_recon_Accounts'
DECLARE 
	@number int = 1,
	@Name nvarchar(50) = 'Konto',
	@PasswordExpires datetime = getdate()

WHILE @number <= 100
BEGIN
INSERT INTO recon.Accounts
           (AccountExId
		   ,CountryRegionCode 
		   ,SystemExId
		   ,ServerExId
           ,Name
		   ,Description
           ,Type)

		   SELECT TOP (10)
			 a.ExternalId
			,(select cr.CountryRegionCode from repository.CountryRegion cr WHERE cr.CountryId = FLOOR(RAND()*(a.AccountId-0+10))+10) AS CountryRegionCode
			,s2.ExternalId AS SystemExId
			,s.ExternalId AS ServerExId
			,case 
				when a.Name LIKE '%1%' THEN NULL
				ELSE a.Name 
				END AS Name
			,case 
				when a.Name LIKE '%5%' THEN 'Test'
				ELSE Description
				END AS Description
			,Type
		FROM 
			repository.Accounts a
			LEFT JOIN repository.Servers s ON s.ServerId = a.ServerId
			LEFT JOIN repository.Systems s2 ON s2.SystemId = a.SystemId
		ORDER BY NEWID()

    SET @number = @number + 1;
END
PRINT 'Stop INSERT_INTO_recon_Accounts'
COMMIT TRAN INSERT_INTO_recon_Accounts
GO

-- Enable all the constraint in database
EXEC sp_msforeachtable "ALTER TABLE ? WITH CHECK CHECK CONSTRAINT all"
GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
CREATE TABLE [#__checkStatus] (
    id           INT            IDENTITY (1, 1) PRIMARY KEY CLUSTERED,
    [Schema]     NVARCHAR (256),
    [Table]      NVARCHAR (256),
    [Constraint] NVARCHAR (256)
);

SET NOCOUNT ON;

DECLARE tableconstraintnames CURSOR LOCAL FORWARD_ONLY
    FOR SELECT SCHEMA_NAME([schema_id]),
               OBJECT_NAME([parent_object_id]),
               [name],
               0
        FROM   [sys].[objects]
        WHERE  [parent_object_id] IN (OBJECT_ID(N'repository.Accounts'), OBJECT_ID(N'gr_user.Users'))
               AND [type] IN (N'F', N'C')
                   AND [object_id] IN (SELECT [object_id]
                                       FROM   [sys].[check_constraints]
                                       WHERE  [is_not_trusted] <> 0
                                              AND [is_disabled] = 0
                                       UNION
                                       SELECT [object_id]
                                       FROM   [sys].[foreign_keys]
                                       WHERE  [is_not_trusted] <> 0
                                              AND [is_disabled] = 0);

DECLARE @schemaname AS NVARCHAR (256);

DECLARE @tablename AS NVARCHAR (256);

DECLARE @checkname AS NVARCHAR (256);

DECLARE @is_not_trusted AS INT;

DECLARE @statement AS NVARCHAR (1024);

BEGIN TRY
    OPEN tableconstraintnames;
    FETCH tableconstraintnames INTO @schemaname, @tablename, @checkname, @is_not_trusted;
    WHILE @@fetch_status = 0
        BEGIN
            PRINT N'Checking constraint: ' + @checkname + N' [' + @schemaname + N'].[' + @tablename + N']';
            SET @statement = N'ALTER TABLE [' + @schemaname + N'].[' + @tablename + N'] WITH ' + CASE @is_not_trusted WHEN 0 THEN N'CHECK' ELSE N'NOCHECK' END + N' CHECK CONSTRAINT [' + @checkname + N']';
            BEGIN TRY
                EXECUTE [sp_executesql] @statement;
            END TRY
            BEGIN CATCH
                INSERT  [#__checkStatus] ([Schema], [Table], [Constraint])
                VALUES                  (@schemaname, @tablename, @checkname);
            END CATCH
            FETCH tableconstraintnames INTO @schemaname, @tablename, @checkname, @is_not_trusted;
        END
END TRY
BEGIN CATCH
    PRINT ERROR_MESSAGE();
END CATCH

IF CURSOR_STATUS(N'LOCAL', N'tableconstraintnames') >= 0
    CLOSE tableconstraintnames;

IF CURSOR_STATUS(N'LOCAL', N'tableconstraintnames') = -1
    DEALLOCATE tableconstraintnames;

SELECT N'Constraint verification failed:' + [Schema] + N'.' + [Table] + N',' + [Constraint]
FROM   [#__checkStatus];

IF @@ROWCOUNT > 0
    BEGIN
        DROP TABLE [#__checkStatus];
        RAISERROR (N'An error occurred while verifying constraints', 16, 127);
    END

SET NOCOUNT OFF;

DROP TABLE [#__checkStatus];


GO
PRINT N'Update complete.';


GO
